{% extends 'base.html' %}
{% load humanize %}
{% load vendas_extras %}

{% block title %}Histórico de Lotes de Comissão{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Histórico de Lotes</h1>
</div>

<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{% url 'comissoes_dashboard' %}">Gráficos</a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="#">Histórico de Lotes</a>
  </li>
  {% if perms.is_admin or perms.is_gestor or perms.is_financeiro %}
  <li class="nav-item">
    <a class="nav-link" href="{% url 'comissoes_fechamento' %}">Fechamento (Pagar)</a>
  </li>
  {% endif %}
</ul>

<div class="accordion mb-4" id="accordionFiltrosLotes">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltros" aria-expanded="false" aria-controls="collapseFiltros">
        Filtrar Lotes
      </button>
    </h2>
    <div id="collapseFiltros" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionFiltrosLotes">
      <div class="accordion-body">
        
        <form method="GET" action="{% url 'comissoes_historico' %}" class="row g-3" id="filtros-lotes-form">

            {% if perms.is_admin or perms.is_gestor or perms.is_financeiro %}
            <div class="col-md-4">
                <label for="filtro_vendedor" class="form-label">Vendedor</label>
                <select id="filtro_vendedor" name="vendedor" class="form-select">
                    <option value="">Todos</option>
                    {% for vendedor in todos_vendedores %}
                    <option value="{{ vendedor.id }}" {% if request.GET.vendedor == vendedor.id|stringformat:"s" %}selected{% endif %}>
                        {{ vendedor.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="col-md-4">
                <label for="filtro_status" class="form-label">Status do Lote</label>
                <select id="filtro_status" name="status" class="form-select">
                    <option value="">Todos os Status</option>
                    {% for chave, valor in status_lote_choices %}
                    <option value="{{ chave }}" {% if request.GET.status == chave %}selected{% endif %}>
                        {{ valor }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Data Fechamento (Início)</label>
                <input type="date" class="form-control" name="data_inicio" value="{{ request.GET.data_inicio|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Data Fechamento (Fim)</label>
                <input type="date" class="form-control" name="data_fim" value="{{ request.GET.data_fim|default:'' }}">
            </div>

            <div class="col-md-3 d-flex align-items-end mt-4">
                 <a href="{% url 'comissoes_historico' %}" class="btn btn-outline-secondary w-100">Limpar</a>
            </div>
            <div class="col-md-3 d-flex align-items-end mt-4">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
            <div class="col-md-3 d-flex align-items-end mt-4">
                 <button type="button" id="btn-export-lotes-csv" class="btn btn-success w-100">Exportar .CSV</button>
            </div>
            <div class="col-md-3 d-flex align-items-end mt-4">
                <button type="button" id="btn-export-lotes-xlsx" class="btn btn-success w-100">Exportar .XLSX</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="tabelaLotes">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Lote ID</th>
                        <th scope="col">Vendedor</th>
                        <th scope="col">Período de Vendas</th>
                        <th scope="col" class="col-num">Data Fechamento</th>
                        <th scope="col" class="col-num">Total Devido</th>
                        <th scope="col" class="col-num">Total Pago</th>
                        <th scope="col" class="col-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote in lotes_pagos %}
                    <tr>
                        <td><a href="{% url 'comissoes_lote_detalhe' lote.id %}"><strong>#{{ lote.id }}</strong></a></td>
                        <td>{{ lote.vendedor.username }}</td>
                        <td>{{ lote.periodo_inicio|date:"d/m/y" }} a {{ lote.periodo_fim|date:"d/m/y" }}</td>
                        <td class="col-num">{{ lote.data_fechamento|date:"d/m/Y H:i" }}</td>
                        <td class="col-num">R$ {{ lote.total_comissoes|intcomma }}</td>
                        <td class="col-num">
                            <span class="{% if lote.total_pago_efetivamente >= lote.total_comissoes %}text-success{% endif %}">
                                R$ {{ lote.total_pago_efetivamente|intcomma }}
                            </span>
                        </td>
                        <td class="col-center"><span class="badge bg-{{ lote.status|status_to_color }} text-dark">{{ lote.get_status_display }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-4">Nenhum lote encontrado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- (Script do Acordeão e de Exportação - sem mudanças) ---
    // ...

    // --- === SCRIPT CORRIGIDO (Tabela Interativa) === ---
    const dataTableLotes = document.getElementById('tabelaLotes');
    if (dataTableLotes) {
        new simpleDatatables.DataTable(dataTableLotes, {
            searchable: true,
            sortable: true,
            perPage: 15,
            perPageSelect: [15, 25, 50, 100],
            labels: {
                placeholder: "Pesquisar nesta lista...",
                // CORREÇÃO: Removido o "{select}"
                perPage: "lotes por página",
                noRows: "Nenhum lote encontrado",
                info: "A mostrar {start} a {end} de {rows} lotes",
            }
        });
    }
});
</script>
{% endblock %}